---
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    fig_caption: yes
title: "MADE : Measuring Adaptive Distance and vaccine Efficacy using allelic barcodes"
params:
  id: "NA"
  def: "NA"
  strain: "NA"
  host: "NA"
  pass: "NA"
---

<span style="font-family:Arial; font-size:0.8em;">This report was generated using **MADE (Measuring Adaptive Distance and vaccine Efficacy using allelic barcodes)** at Genome Institute of Singapore, A*STAR, Singapore.</span>

<span style="font-family:Arial; font-size:0.8em;">In our companion study, we found that the strength of passage adaptation in embryonated eggs (measured as the Adaptive Distance or AD) negatively correlates with vaccine efficacy. Using this general principle, MADE enables users to calibrate the strength of egg passage adaptation and predict vaccine efficacy of a candidate influenza vaccine strain.</span>

<span style="font-family:Arial; font-size:0.8em;">For users preferring command line options, please refer to https://github.com/chenh1gis/MADE_docker.</span>

<span style="font-family:Arial; font-size:0.8em;">For interactive interface, please refer to https://data-hub.gis.a-star.edu.sg/MADE.</span>
  
### <span style="font-family:Arial; font-size:1em;">Virus Isolate Information</span>
```{r include = FALSE}
library(hash)
library(beeswarm)
library(knitr)

id <- params$id
def <- params$def
strain <- params$strain
host <- params$host
pass <- params$pass
date <- paste0(format(Sys.time(),tz="Asia/Singapore","%Y-%m-%d %H:%M:%S %Z"))

DAT=read.table("../data/H3N2/H3N2_enrichment_scores_329codons", header=TRUE, sep="\t")
ALLE=read.table("file_allele.txt",header=TRUE,sep="\t")
ALLE[,2]<-sapply(ALLE[,2],as.character) 
H=hash()
for (i in 1:nrow(ALLE))
  .set(H,keys=ALLE[i,1],values=ALLE[i,2])

ALLELE = data.frame(AminoAcid=character(),Codon=integer(),OR=double(),IsCandidate=integer(),stringsAsFactors = FALSE)
CODON=c(138,145,156,158,159,160,183,186,190,193,194,219,226,246)
for (i in 1:nrow(DAT))
  if (DAT[i,1]==138 | DAT[i,1]==145 | DAT[i,1]==156 | DAT[i,1]==158 | DAT[i,1]==159 | DAT[i,1]==160 | DAT[i,1]==183 | DAT[i,1]==186 | DAT[i,1]==190 | DAT[i,1]==193 | DAT[i,1]==194 | DAT[i,1]==219 | DAT[i,1]==226 | DAT[i,1]==246)
  {
    row=nrow(ALLELE)+1
    ALLELE[row,1]<-as.character(DAT[i,2])
    ALLELE[row,2]<-DAT[i,1]
    ALLELE[row,3]<-DAT[i,3]
    if (values(H,as.character(ALLELE[row,2]))==ALLELE[row,1])
    {
      ALLELE[row,4]<-1
    }else
    {
      ALLELE[row,4]<-0
    }
  }

GISAID=read.table("../data/H3N2/H3N2_background_strains_14alleles", header=TRUE, sep="\t")
GISAID[,c(1,3)] <- sapply(GISAID[,c(1,3)],as.character) 
GISAID[nrow(GISAID) + 1,1:3] = c("TEST","NA","TEST")

DAT[,c(2)] <- sapply(DAT[,c(2)],as.character) 
CODON=c(138,145,156,158,159,160,183,186,190,193,194,219,226,246)
j=3
for(i in 1:14)
{
  j=j+1
  if (ALLE[which(ALLE$CODON==CODON[i]),2]!="NA")
  {
    if (DAT[which (DAT$Codon==CODON[i] & DAT$AminoAcid==ALLE[which(ALLE$CODON==CODON[i]),2]),3]!="NA")
    {GISAID[nrow(GISAID),j] = DAT[which(DAT$Codon==CODON[i] & DAT$AminoAcid==ALLE[which(ALLE$CODON==CODON[i]),2]),3]
    } else {stop(cat('The input of amino acid state over codon "',CODON[i],'" is not available in the list!\n', sep=''))}
  } else {stop(cat('The amino acid state over codon "',CODON[i],'" is missing in the input list!\n', sep=''))}
}
  
PCA <- princomp(GISAID[,4:17])
pc=c(1,2)
SCORE=PCA$scores
SCORE1=cbind(SCORE,GISAID$Passage)
SCORE=cbind(SCORE1,GISAID$Year)
colnames(SCORE)=c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14","PASSAGE","YEAR")

DIS = data.frame(Year=integer(),SpatialDistance=double())
for (i in 2010:2016)
{
  PC1vacc=PC2vacc=0
  PC1bg=PC2bg=0
  dis=0
  VACCINE=SCORE[which(SCORE[,"YEAR"]==i & SCORE[,"PASSAGE"]=="EGG_VACCINE"),]
  BACKGROUND=SCORE[which(SCORE[,"YEAR"]==i & SCORE[,"PASSAGE"]!="EGG_VACCINE"),]
  for (j in 1:nrow(BACKGROUND))
    PC1bg=PC1bg+as.numeric(BACKGROUND[j,1])
    PC2bg=PC2bg+as.numeric(BACKGROUND[j,2])
  PC1bg=PC1bg/nrow(BACKGROUND)
  PC2bg=PC2bg/nrow(BACKGROUND)
  for (j in 1:nrow(VACCINE))
  {
    PC1vacc=as.numeric(VACCINE[j,1])
    PC2vacc=as.numeric(VACCINE[j,2])
    dis=dis+((PC1vacc - PC1bg)**2+(PC2vacc - PC2bg)**2)**0.5
  }
  dis=dis/nrow(VACCINE)
  DIS[nrow(DIS) + 1,1:2] = c(i,dis)
}

PC1test=PC2test=0
PC1bg=PC2bg=distT=0
TEST=SCORE[which(SCORE[,"PASSAGE"]=="TEST"),]
PC1test=as.numeric(TEST[1])
PC2test=as.numeric(TEST[2])
BACKGROUND=SCORE[which(SCORE[,"PASSAGE"]!="EGG_VACCINE" & SCORE[,"PASSAGE"]!="TEST"),]
for (j in 1:nrow(BACKGROUND))
  PC1bg=PC1bg+as.numeric(BACKGROUND[j,1])
  PC2bg=PC2bg+as.numeric(BACKGROUND[j,2])
PC1bg=PC1bg/nrow(BACKGROUND)
PC2bg=PC2bg/nrow(BACKGROUND)
disT=((PC1test - PC1bg)**2+(PC2test - PC2bg)**2)**0.5 # adaptive distance of tested isolate

VE=c(0.46,0.32,0.40,0.10,0.07,NA)
lm = lm(VE ~ DIS$SpatialDistance[1:6])
lmsum = summary(lm)
veT = lmsum$coefficients[2,1]*disT + lmsum$coefficients[1,1]  # vaccine efficacy of tested isolate

AD = data.frame(Year=integer(),SpatialDistance=double())
for (i in 1:nrow(BACKGROUND))
{
  dis=((as.numeric(BACKGROUND[i,1]) - PC1bg)**2+(as.numeric(BACKGROUND[i,2]) - PC2bg)**2)**0.5
  AD[nrow(AD)+1,1:2] = c(BACKGROUND[i,16],dis)
}
AD=cbind(BACKGROUND[,"PASSAGE"],AD)
colnames(AD)=c("Passage","Year","SpatialDistance")
quantile=quantile(as.numeric(AD$SpatialDistance), c(.05, .95)) 
f=ecdf(as.numeric(AD$SpatialDistance))
percent=f(disT)

ADE=AD[which(AD[,"Passage"]=="EGG"),]
quantile1=quantile(as.numeric(ADE$SpatialDistance), c(.10, .90)) 
f=ecdf(as.numeric(ADE$SpatialDistance))
percentE=f(disT)

disT = trunc(disT*10^3)/10^3
veT = trunc(veT*10^3)/10^3

# recommendation
recom <- paste('Please note that the 5% quantile of Adaptive Distance is ',quantile[[1]],'and the 95% quantile is ',quantile[[2]],'.')
```
  * <span style="font-family:Arial; font-size:0.8em;">Public_ID : `r id`</span>
  * <span style="font-family:Arial; font-size:0.8em;">Definition : `r def`</span>
  * <span style="font-family:Arial; font-size:0.8em;">Strain : `r strain`</span>
  * <span style="font-family:Arial; font-size:0.8em;">Host : `r host`</span>
  * <span style="font-family:Arial; font-size:0.8em;">Passage : `r pass`</span>
  * <span style="font-family:Arial; font-size:0.8em;">Report Date : `r date`</span>

### <span style="font-family:Arial; font-size:1em;">Results & Recommendation</span>

<span style="font-family:Arial; font-size:0.9em;">**Probability of Egg Passage : **</span>

<span style="font-family:Arial; font-size:0.9em;">**Adaptive Distance : **</span>
<span style="color:blue; font-family:Arial; font-size:0.9em;">**`r disT`**</span>

<span style="font-family:Arial; font-size:0.9em;">**Predicted Vaccine Efficacy : **</span>
<span style="color:blue; font-family:Arial; font-size:0.9em;">**`r veT`**</span>

<span style="font-family:Arial; font-size:0.9em;">*`r recom`*</span>

### <span style="font-family:Arial; font-size:1em;">Synopsis</span>

<span style="font-family:Arial; font-size:0.8em;">During vaccine production, influenza viruses are unavoidably propagated in embryonated eggs. In the culture expansion, flu viruses adapt to the egg environment, a process known as passage adaptation. In our companion study, we found that egg passage adaptation is driven by repeated substitutions (i.e. convergent evolution) over key codons and passage adaptation often leads to highly specific alleles in egg-passaged strains. Using a statistical analysis of these sites, we develop a metric of Adaptive Distance (AD) quantifying the strength of passage adaptation and show that there is a strong negative correlation between AD of a vaccine strain and vaccine efficacy. Based on these observations and principles, we developed MADE (Measuring Adaptive Distance and vaccine Efficacy using allelic barcodes) for vaccine developers to measure the strength of passage adaptation and predict the efficacy of a vaccine strain based on its nucleotide sequence.</span>

***

### <span style="font-family:Arial; font-size:1em;">Adaptive Distance</span>
```{r fig1, echo = FALSE, fig.align="center"}

############### PCA - all strains #################

minpc1=as.integer(min(as.integer(SCORE[,1]))-3)
minpc2=as.integer(min(as.integer(SCORE[,2]))-4)

num=array(0,dim=c(30,35))
for (i in 1:nrow(BACKGROUND))
  num[as.integer((as.numeric(BACKGROUND[i,1])-minpc1)/1),as.integer((as.numeric(BACKGROUND[i,2])-minpc2)/1)]=num[as.integer((as.numeric(BACKGROUND[i,1])-minpc1)/1),as.integer((as.numeric(BACKGROUND[i,2])-minpc2)/1)]+1

COUNT = data.frame(X=double(),Y=double(),Number=integer())
for (i in 1:30)
  for (j in 1:35)
    for (n in 1:num[i,j])
      COUNT[nrow(COUNT) + 1,1:3] = c(i*1+minpc1,j*1+minpc2,num[i,j])

smoothScatter(COUNT$X,COUNT$Y,colramp = colorRampPalette(c("cornflowerblue","slategray1","mistyrose", "pink","red")),pch="",xlab=paste0("PC", pc[1], " (", round(PCA$sdev[pc[1]]/sum(PCA$sdev)*100,0), "%)"), ylab=paste0("PC", pc[2], " (", round(PCA$sdev[pc[2]]/sum(PCA$sdev)*100,0), "%)"),cex.lab=1,cex.axis=.8,main="Principle component plot of all virus isolates")
points(x=PC1test,y=PC2test,pch=19,cex=1)
text(x=PC1test,y=PC2test-1,labels="vaccine strain", cex= 1, offset = 10)

# legend of fig 1

fig1l <- "The enrichment scores calculated at the multiple codons will define a multidimensional space. Using principle component analysis, we projected the high dimensions down to the first two principle components (PC). When plotting all virus strains in the database onto this PCA map (each isolate is a dot ), we found that most of the virus strains in the PCA map are highly clustered and only a small proportion of strains passaged in embryonated eggs form separate clusters distinct from the major cluster. We thus defined an adaptive distance (AD) measuring the separation between the major cluster and the target strain."

fig1 <- paste('AD of the focal strain is ',disT,'. This value is higher than ',percent,' of all strains in the database. If comparing to egg passage strains, this adaptive distance locates at the ',percentE,' quantile.',sep='')
```
  <span style="font-family:Arial; font-size:0.8em;">*`r fig1l`*</span>

  <span style="font-family:Arial; font-size:0.8em;">*`r fig1`*</span>
  
***

### <span style="font-family:Arial; font-size:1em;">Predicted Vaccine Efficacy</span>
```{r fig2, echo = FALSE, fig.align="center"}

############## scatterplot ###################

plot(DIS$SpatialDistance[1:6], VE, pch = 16, type = 'p', las = 1,cex=1,
     xlab = 'Adaptive distance',
     ylab = 'Vaccine efficacy',
     cex.lab=1,cex.axis=.8,
     main="Correlation between vaccine efficacy and adaptive distance"
     )
abline(lmsum$coefficients[1:2],lwd=2)
r2 = lmsum$adj.r.squared
mylabel = bquote(italic(R)^2 == .(format(r2, digits = 3)))
text(x = 22, y = 0.45, cex=1,labels = mylabel,font=4)
points(x=disT,y=veT,pch=19,cex=1,col="red")
veT1=formatC(veT,digits=2, format="f")
veE=paste('VE = ',veT1,sep='')
text(x=disT+0.5,y=veT+0.05,labels=veE, cex=1, offset = 10)
disT1=formatC(disT,digits=2, format="f") 
disE=paste('AD = ',disT1,sep='')
text(x=disT+0.6,y=veT+0.02,labels=disE, cex=1, offset = 10)
nx=c(0,disT)
ny=c(veT,veT)
lines(nx,ny,lwd=1.5,lty=2,col="red")
nx=c(disT,disT)
ny=c(0,veT)
lines(nx,ny,lwd=1.5,lty=2,col="red")

lmsum$coefficients[2,1] = trunc(lmsum$coefficients[2,1]*10^4)/10^4
lmsum$coefficients[1,1] = trunc(lmsum$coefficients[1,1]*10^4)/10^4

# legend of fig 2

fig2l="Using vaccine efficacy data (between year 2010-2015) curated by a recent study (Belongia EA, et al. 2016), we plotted the adaptive distance (AD) of past vaccine strains and the corresponding vaccine efficacy (VE).High R-square 0.774 indicate strongly negative correlation between AD and VE."

fig2=paste('Using this linear relationship and estimated adaptive distance of ',disT,', the predicted vaccine efficacy for the focal strain submitted by the user is ',veT,'.', sep='');
```
  <span style="font-family:Arial; font-size:0.8em;">*`r fig2l`*</span>

  <span style="font-family:Arial; font-size:0.8em;">*`r fig2`*</span>
  
***
### <span style="font-family:Arial; font-size:1em;">Supporting Materials</span>
#### <span style="font-family:Arial; font-size:1em;">Approach</span>

<span style="font-family:Arial; font-size:0.8em;">MADE is a computational package developed for the research community to measure the strength of egg passage adaptation and predict the potential vaccine efficacy of a candidate strain based on its nucleotide sequence. Using the allelic state of the key codons driving egg passage adaptation (see our companion study and manual), MADE will:</span>

<span style="font-family:Arial; font-size:0.8em;">1) Measure the strength of egg passage adaptation in the target strain submitted by the user.</span>

<span style="font-family:Arial; font-size:0.8em;">2) compute the posterior probability that the target strain is passaged in embryonated eggs.</span>

<span style="font-family:Arial; font-size:0.8em;">3) predict the potential vaccine efficacy of the target strain.</span>

***
#### <span style="font-family:Arial; font-size:1em;">Enrichment scores</span>

```{r fig3, echo = FALSE, fig.align="center"}

##################### beeswarm #######################################

boxplot(OR ~ Codon, data = ALLELE,boxwex=.6, col="gray",ylab="Enrichment score",xlab="Codon position",cex.lab=1,cex.axis=0.8,main="Enrichment scores across key alleles")
beeswarm=beeswarm(OR ~ Codon, data = ALLELE, col="black", pch=19,cex=.8,pwcol = 1 + as.numeric(IsCandidate),add=TRUE,position='center',corralWidth=0.2)

outlier <-0
OUTLIER=ALLELE[which(ALLELE[,"IsCandidate"]==1),]
for (i in 1:nrow(OUTLIER))
{
  if (OUTLIER[i,3]>=15)
  {
    outlier=outlier+1
    if (as.numeric(outlier)==1)
    {
      term=paste(OUTLIER[i,2],OUTLIER[i,1],sep='');
    }
    else
    {
      term=paste(term,' ',OUTLIER[i,2],OUTLIER[i,1],sep='');
    }
  }
}

# legend of fig 3

fig3l <- "Enrichment scores(ES) measures the enrichment of specific alleles in egg passaged strains High ES indicates strong egg passage adaptation."

if (as.numeric(outlier) != 1){
  fig3 <- paste('Allele ',term,' carries a high enrichment score in the focal strain',sep=''); 
} else {
  fig3 <- "No allele carries high enrichment score across those selected codons in the focal strain.";
}
```

  <span style="font-family:Arial; font-size:0.8em;">*`r fig3l`*</span>

  <span style="font-family:Arial; font-size:0.8em;">*`r fig3`*</span>

***
#### <span style="font-family:Arial; font-size:1em;">Distribution of Egg Passaged Viruses</span>

```{r fig4, echo = FALSE, fig.align="center"}

############### PCA - egg strains #################

minpc1=as.integer(min(as.integer(SCORE[,1]))-3)
minpc2=as.integer(min(as.integer(SCORE[,2]))-4)

EGG=SCORE[which(SCORE[,"PASSAGE"]=="EGG"),]

num=array(0,dim=c(30,35))
for (i in 1:nrow(EGG))
  num[as.integer((as.numeric(EGG[i,1])-minpc1)/1),as.integer((as.numeric(EGG[i,2])-minpc2)/1)]=num[as.integer((as.numeric(EGG[i,1])-minpc1)/1),as.integer((as.numeric(EGG[i,2])-minpc2)/1)]+1

COUNT = data.frame(X=double(),Y=double(),Number=integer())
for (i in 1:30)
  for (j in 1:35)
    for (n in 1:num[i,j])
      COUNT[nrow(COUNT) + 1,1:3] = c(i*1+minpc1,j*1+minpc2,num[i,j])

smoothScatter(COUNT$X,COUNT$Y,colramp = colorRampPalette(c("cornflowerblue","slategray1","red")),pch="",xlab=paste0("PC", pc[1], " (", round(PCA$sdev[pc[1]]/sum(PCA$sdev)*100,0), "%)"), ylab=paste0("PC", pc[2], " (", round(PCA$sdev[pc[2]]/sum(PCA$sdev)*100,0), "%)"),cex.lab=1,cex.axis=.8,main="Principle component plot of egg passaged virus isolates")
points(x=PC1test,y=PC2test,pch=19,cex=1)
text(x=PC1test,y=PC2test-1,labels="vaccine strain", cex= 1, offset = 10)

# legend of fig 4

fig4l <- "Principle component plot of the multidimensional enrichment scores across all egg passaged strains. Each strain is a dot in the PCA map. These egg-passaged strains seem to be clustered into different groups and bear different levels of strength from egg passage adaptation."
```
  <span style="font-family:Arial; font-size:0.8em;">*`r fig4l`*</span>

***
#### <span style="font-family:Arial; font-size:1em;">Adaptive Distances of Egg Passaged Viruses</span>

```{r fig5, echo = FALSE, fig.align="center"}

############## Density ################

DISTANCE = data.frame(Year=integer(),Passage=character(),SpatialDistance=double(),stringsAsFactors = FALSE)
BACKGROUND=SCORE[(SCORE[,"PASSAGE"]=="EGG"),]
for (i in 1:nrow(BACKGROUND))
{
  PC1dis=as.numeric(BACKGROUND[i,1])
  PC2dis=as.numeric(BACKGROUND[i,2])
  dis=((PC1dis - PC1bg)**2+(PC2dis - PC2bg)**2)**0.5
  DISTANCE[nrow(DISTANCE) + 1,1:3] =   suppressWarnings(c(as.integer(BACKGROUND[i,16]),as.character(BACKGROUND[i,15]),dis))
}

d=density(as.numeric(DISTANCE$SpatialDistance))
plot(d, xlab="Adaptive distance",cex.lab=1,cex.axis=.8,main = "Adaptive distances for egg passaged virus isolates")
polygon(d, col="gray", border="gray")
abline(v=disT,col='red',lwd=2) 

# legend of fig 5

fig5l <- "In general, adaptive distance (AD) calculated from the egg passage strains form two major clusters, indicating weak and strong signature of egg passage adaptation respectively."
```

  <span style="font-family:Arial; font-size:0.8em;">*`r fig5l`*</span>

***
#### <span style="font-family:Arial; font-size:1em;">Vaccine Isolates from Year 2010-2015</span>

```{r fig6, echo = FALSE, fig.align="center"}

###################### Trajctories ##############
 par(mar=c(6, 5, 5, 4))
 ## Plot first set of data and draw its axis
 plot(DIS$Year[1:6], DIS$SpatialDistance[1:6], pch=19, axes=FALSE,  xlab="", ylab="",type="b",col="black",cex.main=1.2,ylim=c(0,30))
 #abline(h=disT,col='red',lwd=2)
 axis(2, col="black",las=1,cex.axis=.8)  ## las=1 makes horizontal labels
 mtext("Distance",side=2,line=2.5,cex=1)
 box()
 ## Allow a second plot on the same graph
 par(new=TRUE)
 VE=c(0.46,0.32,0.40,0.10,0.07,NA)
 YR=c("2010-2011","2011-2012","2012-2013","2013-2014","2014-2015","2015-2016")
 ## Plot the second plot and put axis scale on right
 plot(DIS$Year[1:6], VE, pch=15,  xlab="", ylab="", ylim=c(0,0.5), axes=FALSE, type="b", col="blue",main="Adaptive distances for the vaccine strains between year 2010-2015")
 ## a little farther out (line=4) to make room for labels
 mtext("Vaccine efficacy",side=4,col="black",line=4,cex=1.2) 
 axis(4, ylim=c(0,0.5), cex.axis=.8, col="black",col.axis="black",las=1)
 ## Draw the time axis
 axis(1, 2010:2016,YR[1:7],cex.axis=.8)
 #axis(1,YR)
 mtext("Year windows",side=1,col="black",line=2.5,cex=1)  
 ## Add Legend
 legend("topright",legend=c("Adaptive Distance","Vaccine_Efficacy"),pch=c(19,15),col=c("black","blue"),cex=.8)
 
 # legend of fig 6
 fig6 <- "Adaptive distance (AD) from past vaccine strains between year 2010 and 2015 were plotted together with the corresponding vaccine efficacy (VE)."
```
<span style="font-family:Arial; font-size:0.8em;">*`r fig6`*</span>

***

#### <span style="font-family:Arial; font-size:1em;">Reference</span>
  * <span style="font-family:Arial; font-size:0.8em;">*Skowronski DM, et al. (2014) Low 2012-13 influenza vaccine effectiveness associated with mutation in the egg-adapted H3N2 vaccine strain not antigenic drift in circulating viruses. PloS one 9(3):e92153.*</span>
  * <span style="font-family:Arial; font-size:0.8em;">*Chen H, et al. (2016) Dynamic Convergent Evolution Drives the Passage Adaptation across 48 Years' History of H3N2 Influenza Evolution. Mol Biol Evol 33(12):3133-3143.*</span>
  * <span style="font-family:Arial; font-size:0.8em;">*Belongia EA, et al. (2016) Variable influenza vaccine effectiveness by subtype: a systematic review and meta-analysis of test-negative design studies. The Lancet. Infectious diseases 16(8):942-951.*</span>
  * <span style="font-family:Arial; font-size:0.8em;">*Zost SJ PK, Gumina ME, Kim K, Diaz Perez S, Wilson PC, Treanor JJ, Sant AJ, Cobey S, Hensley SE (2017) Contemporary H3N2 influenza viruses have a glycosylation site that alters binding of antibodies elicited by egg-adapted vaccine strains. Proceedings of the National Academy of Sciences of the United States of America.*</span>


